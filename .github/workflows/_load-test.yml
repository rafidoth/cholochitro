name: Load Test

on:
  workflow_dispatch:
    inputs:
      test_script:
        description: 'Test script to run'
        required: true
        default: 'health'
        type: choice
        options:
          - health
          - auth-flow
          - read-heavy
          - seat-race
          - full-journey
      vus:
        description: 'Number of virtual users'
        required: false
        default: '10'
        type: string
      duration:
        description: 'Test duration (e.g., 30s, 1m, 5m)'
        required: false
        default: '1m'
        type: string
      profile:
        description: 'Test profile (smoke, dev, load, stress)'
        required: false
        default: 'load'
        type: choice
        options:
          - smoke
          - dev
          - load
          - stress

jobs:
  load-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start containers
        run: docker compose up -d --build

      - name: Wait for database to be ready
        run: |
          timeout 60 bash -c 'until docker compose exec -T db pg_isready -U postgres; do sleep 2; done'

      - name: Run database migrations
        run: docker compose exec -T app pnpm migrate up
        env:
          DATABASE_URL: postgres://postgres:postgres@db:5432/cholochitro

      - name: Wait for app to be ready
        run: |
          timeout 60 bash -c 'until curl -s http://localhost:4001/api/v1/health > /dev/null; do sleep 2; done'

      - name: Seed test data via API
        run: node k6/data/_seed-data.js
        env:
          BASE_URL: http://localhost:4001

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Create results directory
        run: mkdir -p k6/results

      - name: Run k6 load test
        run: |
          # Rename underscore-prefixed files for execution
          # (In production, you'd remove the underscores after review)
          
          # Determine the script path
          SCRIPT_NAME="${{ inputs.test_script }}"
          SCRIPT_PATH="k6/scripts/_${SCRIPT_NAME}.js"
          
          # Check if we need to override VUs/duration
          K6_ARGS=""
          
          # For race test, don't override VUs (it has specific requirements)
          if [ "$SCRIPT_NAME" != "seat-race" ]; then
            if [ -n "${{ inputs.vus }}" ]; then
              K6_ARGS="$K6_ARGS --vus ${{ inputs.vus }}"
            fi
            if [ -n "${{ inputs.duration }}" ]; then
              K6_ARGS="$K6_ARGS --duration ${{ inputs.duration }}"
            fi
          fi
          
          # Run k6 with JSON output
          k6 run $SCRIPT_PATH \
            $K6_ARGS \
            -e PROFILE=${{ inputs.profile }} \
            -e BASE_URL=http://localhost:4001 \
            --out json=k6/results/${{ inputs.test_script }}-${{ github.run_id }}.json \
            --summary-export=k6/results/${{ inputs.test_script }}-summary-${{ github.run_id }}.json
        env:
          K6_OUT: json

      - name: Upload k6 results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-results-${{ inputs.test_script }}-${{ github.run_id }}
          path: k6/results/
          retention-days: 30

      - name: Display test summary
        if: always()
        run: |
          echo "=========================================="
          echo "K6 LOAD TEST SUMMARY"
          echo "=========================================="
          echo "Test: ${{ inputs.test_script }}"
          echo "VUs: ${{ inputs.vus }}"
          echo "Duration: ${{ inputs.duration }}"
          echo "Profile: ${{ inputs.profile }}"
          echo "=========================================="
          
          if [ -f "k6/results/${{ inputs.test_script }}-summary-${{ github.run_id }}.json" ]; then
            cat "k6/results/${{ inputs.test_script }}-summary-${{ github.run_id }}.json" | jq '.'
          fi

      - name: Check for race conditions (seat-race only)
        if: inputs.test_script == 'seat-race'
        run: |
          SUMMARY_FILE="k6/results/${{ inputs.test_script }}-summary-${{ github.run_id }}.json"
          
          if [ -f "$SUMMARY_FILE" ]; then
            SUCCESS_COUNT=$(jq '.metrics.booking_success.values.count // 0' "$SUMMARY_FILE")
            
            echo "Booking successes: $SUCCESS_COUNT"
            
            if [ "$SUCCESS_COUNT" -gt 1 ]; then
              echo "::error::RACE CONDITION DETECTED! Multiple bookings ($SUCCESS_COUNT) succeeded for the same seats!"
              exit 1
            elif [ "$SUCCESS_COUNT" -eq 1 ]; then
              echo "::notice::Race condition test PASSED. Exactly 1 booking succeeded."
            else
              echo "::warning::No bookings succeeded. Check test setup."
            fi
          fi

      - name: Cleanup
        if: always()
        run: docker compose down -v
